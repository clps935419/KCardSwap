name: Backend CI

on:
  push:
    branches: [ main, master, develop ]
    paths:
      - 'apps/backend/**'
      - '.github/workflows/backend-ci.yml'
  pull_request:
    branches: [ main, master, develop ]
    paths:
      - 'apps/backend/**'
      - '.github/workflows/backend-ci.yml'

jobs:
  lint:
    name: Lint Python Code
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/backend
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: 1.7.1
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: apps/backend/.venv
        key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
    
    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --no-interaction --no-root
    
    - name: Check poetry.lock is up-to-date
      run: poetry check --lock
    
    - name: Run ruff linter
      run: poetry run ruff check .

  test:
    name: Run Tests
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/backend
    
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: kcardswap
          POSTGRES_PASSWORD: kcardswap
          POSTGRES_DB: kcardswap_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: 1.7.1
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: apps/backend/.venv
        key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
    
    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --no-interaction --no-root
    
    - name: Create PostgreSQL extensions
      env:
        PGPASSWORD: kcardswap
      run: |
        psql -h localhost -U kcardswap -d kcardswap_test -c "CREATE EXTENSION IF NOT EXISTS \"uuid-ossp\";"
    
    - name: Verify migrations can upgrade
      env:
        DATABASE_URL: postgresql://kcardswap:kcardswap@localhost:5432/kcardswap_test
      run: |
        echo "Running Alembic upgrade to head..."
        poetry run alembic upgrade head
        echo "✓ Migrations upgraded successfully"
    
    - name: Verify migrations can downgrade
      env:
        DATABASE_URL: postgresql://kcardswap:kcardswap@localhost:5432/kcardswap_test
      run: |
        echo "Running Alembic downgrade to base..."
        poetry run alembic downgrade base
        echo "✓ Migrations downgraded successfully"
    
    - name: Re-upgrade for tests
      env:
        DATABASE_URL: postgresql://kcardswap:kcardswap@localhost:5432/kcardswap_test
      run: |
        echo "Re-running migrations for tests..."
        poetry run alembic upgrade head
    
    - name: Run tests with coverage
      env:
        DATABASE_URL: postgresql+asyncpg://kcardswap:kcardswap@localhost:5432/kcardswap_test
        JWT_SECRET: test-secret-key
        GCS_BUCKET: test-bucket
      run: poetry run pytest --cov=app --cov-report=xml --cov-report=term-missing

  build:
    name: Build Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: apps/backend
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install Poetry
      uses: snok/install-poetry@v1
      with:
        version: 1.7.1
        virtualenvs-create: true
        virtualenvs-in-project: true
    
    - name: Load cached venv
      id: cached-poetry-dependencies
      uses: actions/cache@v3
      with:
        path: apps/backend/.venv
        key: venv-${{ runner.os }}-${{ hashFiles('**/poetry.lock') }}
    
    - name: Install dependencies
      if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
      run: poetry install --no-interaction --no-root
    
    - name: Check imports and syntax
      run: |
        poetry run python -m py_compile app/main.py
        poetry run python -c "from app.main import app; print('FastAPI app loaded successfully')"
